<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-label/core-label.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<polymer-element name="g-layercatalogus" attributes="activeLayers account filters">
<template>
<style>
.layerItem{
    min-height:30px;
}
.group {
    margin-left:-20px;
    min-width: 350px;
    margin-right:-20px;
}
.group core-collapse {

    padding-left:2px;
    padding-right: 10px;
}
core-item {
    cursor:pointer;
    word-wrap: normal
}
core-collapse {
    background: rgba(225,225,230,0.4);
-webkit-box-shadow: inset 0px 2px 5px 0px rgba(161,161,161,0.62);
-moz-box-shadow: inset 0px 2px 5px 0px rgba(161,161,161,0.62);
box-shadow: inset 0px 2px 5px 0px rgba(161,161,161,0.62);
}
#zoekVeld {
    width: 300px;
}
paper-dropdown-menu,paper-dropdown {
    width: 220px;
}
</style>
<core-ajax id="getConfig"
    auto
    url="{{url}}"
    handeAs="json"
    on-core-response="{{handleResponse}}"
    withCredentials=true
></core-ajax>
<template if="{{account.ID==undefined}}">
<p>U bent niet ingelogd, dus er zijn geen lagen beschikbaar.</p>
</template>
<template  if="{{account.ID!=undefined}}">
<!-- Configuratie:  <paper-dropdown-menu label="{{activeConfig}}">
        <paper-dropdown class="dropdown">
          <core-menu class="menu">
            <template repeat="{{c in configs}}">
              <paper-item on-click="{{changeConfig}}">{{c.title}}</paper-item>
            </template>
          </core-menu>
        </paper-dropdown>
      </paper-dropdown-menu><br/>-->
<paper-input id="zoekVeld" value="{{search}}" label="Zoek een laag"></paper-input>
<template id="layerList" repeat="{{layer in catalogus}}">
<div class="group"><core-item class="groupTitle" icon="arrow-drop-down" label="{{layer.group==null?'Generiek':layer.group}}" on-click="{{toggle}}"><paper-ripple fit></paper-ripple></core-item>
    <core-collapse opened="{{layer.opened}}">
    <template repeat="{{sub in layer.subgroup}}">    
    <div class="subGroup"><core-item class="subGroupTitle" icon="arrow-drop-down" label="{{sub.subname}}" on-click="{{toggle}}"><paper-ripple fit></paper-ripple></core-item>
        <core-collapse on-core-collapse-open="{{resizeGroup}}"  opened="{{sub.opened}}">
        <template repeat="{{l in sub.layers}}">
       <core-item class="layer" vis="{{l.options.visibility}}"  icon="{{l.options.visibility?'check-box':'check-box-outline-blank'}}" label="{{l.options.config.title}}" on-click="{{toggleLayer}}"><paper-ripple fit></paper-ripple></core-item>
        </template>
        </core-collapse>
    </div>
    </template>
    <template repeat="{{l in layer.layers}}">
         <core-item class="layer" vis="{{l.options.visibility}}"  icon="{{l.options.visibility?'check-box':'check-box-outline-blank'}}" label="{{l.options.config.title}}" on-click="{{toggleLayer}}"><paper-ripple fit></paper-ripple></core-item>
    </template>
    </core-collapse>
</div>
</template>
</template>
</template>
<script>

Polymer({
  search: null,
  searchChanged: function() {

    var zoek =this.search;
    var resultaat = this.layers.filter(function(l){
        return l.options.config.title.toLowerCase().indexOf(zoek.toLowerCase())>=0
    })
    var open=zoek==""?false:true;
    this.updateCatalogus(resultaat,open);
                     
  },
  accountChanged: function(){
   
    
    if(this.account.OrganisationCode) {
       // this.$.getConfig.url = 'https://services.geodan.nl:443/document/api/data/'+this.account.OrganisationCode+'/config/'+doc;
        this.$.getConfig.url = 'https://services.geodan.nl:443/document/api/'+this.account.OrganisationCode+'/config/';
    }
  },
  ready: function() {
    
   // alert(this.$.getConfig.url);
    this.layers = this.layers || [];
    this.filters = this.filters || [];
    this.catalogus = this.catalogus || [];
    this.activeLayers = this.activeLayers || [];
    this.account = this.account || {};
    this.configs = [];
    this.activeConfig = '';
  },
  toggle: function(e) {
       e.target.parentElement.icon=e.target.parentElement.icon=='arrow-drop-down'?'arrow-drop-up':'arrow-drop-down';
       e.target.parentElement.nextElementSibling.toggle();
    
  },
  resizeGroup: function(e) {
    var el = e.target.parentElement.parentElement
     setTimeout(function(){
     el.transitionEnd()
     },330);
  },
  toggleLayer: function(e,b,c) {
      var layer = c.templateInstance.model.l; 
      layer.options.visibility = layer.options.visibility?false:true;
      if(layer.options.visibility) this.activeLayers.push(layer);
      else {
        this.activeLayers.splice(this.activeLayers.indexOf(layer),1)
      }
  },
  changeConfig: function(a,b,c) {
    var config = c.templateInstance.model.c; 
    this.activeConfig = config.title;
     this.$.getConfig.url = 'https://services.geodan.nl:443/document/api/data/'+this.account.OrganisationCode+'/config/'+config.name;
  },
  updateCatalogus: function(layerlist,open) {
     this.catalogus = layerlist.reduce(
        function(a,l){
            if(l.options.config.filters&&l.options.config.filters.length>0) {
            return a;
            }
            var group = a.filter(function(d){return d.group == l.options.config.groupName});
            if(group.length == 0) {
                if(l.options.config.subgroupName) {
                    a.push({group:l.options.config.groupName,opened:open,layers:[],subgroup:[{subname:l.options.config.subgroupName,opened:open,layers:[l]}]});
                }
                else {
                    a.push({group:l.options.config.groupName,opened:open,subgroup:[],layers:[l]})
                }
            }
            else {
                if(l.options.config.subgroupName) {
                    var sub = group[0].subgroup.filter(function(d){return d.subname==l.options.config.subgroupName});
                    if(sub.length == 0) {
                        group[0].subgroup.push({subname:l.options.config.subgroupName,opened:open,layers:[l]})
                    }
                    else {
                        sub[0].layers.push(l);
                    }
                }
                else {
                    group[0].layers.push(l)
                }
            }
            return a;
        }, []);
  },
  createCatalogus: function(layerlist,open) {
        this.updateCatalogus(layerlist,open);
        this.filters = layerlist.filter(function(l){
            return l.options.config.filters;
        })

        
         this.activeLayers = layerlist.filter(function(l){
            return l.options.visibility;
        })
  },
  handleResponse: function(d){   
    var response = JSON.parse(d.detail.response);
    if(response.constructor === Array) {
        //just a list of configs
        this.configs = response;
        this.$.getConfig.url = 'https://services.geodan.nl:443/document/api/data/'+this.account.OrganisationCode+'/config/'+this.configs[0].name;
        this.activeConfig = this.configs[0].title;
    }
    else {
        //actual config
        //this.activeLayers = [];
        var config = response.map.layers; 
        var calcZoom = function(scale) {
            var resolutions = [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420, 0.21];
            var res = 0.28*scale/1000; //standard geoserver scale calculation
            var zoom =0;            
            for(var i = 0; i<resolutions.length;i++) {
                if(res<resolutions[i]) zoom++
            }
            return zoom;
        
        };

        var makeWms = function(config) {
            var minZoom = 0;
            if(config.options.maxResolution) {
                minZoom = calcZoom(config.options.maxResolution);
            }
            if(config.filters) {
                config.showup = true;                
            }
            var wms = L.tileLayer.wms(
                config.source.url,
                {
                    layers: config.source.featureName,
                    format: config.source.contenttype?config.source.contenttype:'image/png',
                    transparent: config.options.transparent,
                    opacity: config.options.opacity,
                    visibility: config.options.visible,
                    config: config,
                    minZoom: minZoom
                }
            );        
            return wms
        }
        this.layers = config.map(makeWms);
        this.createCatalogus(this.layers);        
       
     
        //TODO put visible layers in activeLayers
    }
  }
});
</script>
</polymer-element>